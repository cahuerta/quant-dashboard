<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Quant Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: linear-gradient(180deg,#020617,#0f172a);
      color: #e5e7eb;
      margin: 0;
      padding: 20px;
    }
    .container { max-width: 1100px; margin: auto; }

    h1 { font-size: 26px; margin-bottom: 4px; }
    p.subtitle { color:#94a3b8; margin-top:0; }

    .card {
      background: radial-gradient(120% 120% at top,#020617,#020617 40%,#020617cc);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid #1e293b;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }

    select {
      background: #020617;
      color: #e5e7eb;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #334155;
      font-size: 16px;
    }

    .kpis {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }

    .kpi span {
      font-size: 12px;
      color: #94a3b8;
      letter-spacing: .04em;
    }

    .kpi strong {
      font-size: 22px;
      display: block;
      margin-top: 6px;
    }

    .badge {
      padding: 6px 14px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 13px;
      display: inline-block;
    }

    .OBS { background:#334155; color:#e5e7eb; }
    .GOOD { background:#16a34a; }
    .WEAK { background:#ca8a04; }
    .NOISE { background:#dc2626; }

    .fundamental strong { color:#38bdf8; }
    .technical strong { color:#e5e7eb; }

    canvas { margin-top:10px; }
  </style>
</head>

<body>
<div class="container">

<h1>ðŸ“ˆ Quant Dashboard</h1>
<p class="subtitle">Modelo tÃ©cnico + valor fundamental (dividendos)</p>

<!-- Selector -->
<div class="card">
  <label>Activo:</label><br><br>
  <select id="ticker"></select>
</div>

<!-- MODELO TÃ‰CNICO -->
<div class="card kpis technical">
  <div class="kpi"><span>RecomendaciÃ³n</span><strong id="rec">â€“</strong></div>
  <div class="kpi"><span>Precio actual</span><strong id="pnow">â€“</strong></div>
  <div class="kpi"><span>Precio proyectado</span><strong id="ppred">â€“</strong></div>
  <div class="kpi"><span>Retorno esperado</span><strong id="ret">â€“</strong></div>
  <div class="kpi"><span>Horizonte</span><strong id="horizon">â€“</strong></div>
  <div class="kpi"><span>Seguimiento</span><strong id="tracking">â€“</strong></div>
  <div class="kpi"><span>Estado modelo tÃ©cnico</span><strong id="state">â€“</strong></div>
</div>

<!-- MODELO FUNDAMENTAL -->
<div class="card kpis fundamental">
  <div class="kpi"><span>Precio mercado</span><strong id="p_mkt">â€“</strong></div>
  <div class="kpi"><span>Precio fundamental</span><strong id="p_fund">â€“</strong></div>
  <div class="kpi"><span>Fundamental T+10</span><strong id="p_fund_t10">â€“</strong></div>
  <div class="kpi"><span>DesalineaciÃ³n</span><strong id="mispricing">â€“</strong></div>
  <div class="kpi"><span>Dividend yield</span><strong id="div_yield">â€“</strong></div>
</div>

<!-- GRÃFICO -->
<div class="card">
  <p id="chart-info" style="color:#94a3b8;font-size:13px">
    PredicciÃ³n activa. AÃºn no hay datos reales para evaluaciÃ³n.
  </p>
  <canvas id="chart" height="120"></canvas>
</div>

</div>

<script>
const API = "https://spy-2w-price-prediction.onrender.com";
const sel = document.getElementById("ticker");
const el = id => document.getElementById(id);
let chart;

async function j(url){ return (await fetch(url)).json(); }

// ===============================
// Activos
// ===============================
async function loadTickers(){
  const d = await j(`${API}/signals`);
  sel.innerHTML = "";
  d.signals.forEach(s=>{
    const o=document.createElement("option");
    o.value=s.ticker;
    o.textContent=s.ticker;
    sel.appendChild(o);
  });
  loadSignal(sel.value);
}

// ===============================
// MODELO TÃ‰CNICO
// ===============================
async function loadSignal(t){
  const d = await j(`${API}/signals/${t}`);
  const s = d.signal;

  el("rec").textContent = s.recommendation;
  el("pnow").textContent = s.price_now.toFixed(2);
  el("ppred").textContent = s.price_pred.toFixed(2);
  el("ret").textContent = s.ret_ens_pct.toFixed(2) + "%";
  el("horizon").textContent = "10 sesiones";

  // ðŸ”´ CORRECCIÃ“N CLAVE â†’ backend manda el estado
  let conf = null;
  try {
    conf = await j(`${API}/confidence?ticker=${t}`);
  } catch {}

  if (!conf || !conf.ok) {
    el("tracking").textContent =
      `En observaciÃ³n (desde ${s.date_base})`;
    el("state").innerHTML = `<span class="badge OBS">En observaciÃ³n</span>`;
  } else {
    el("tracking").textContent =
      `Evaluado (${conf.n} observaciones)`;
    el("state").innerHTML = `<span class="badge OBS">Evaluado</span>`;
  }

  loadChart(t);
  loadFundamental(t);
}

// ===============================
// MODELO FUNDAMENTAL
// ===============================
async function loadFundamental(t){
  const d = await j(`${API}/predict/fundamental?ticker=${t}`);

  if (!d.ok) {
    ["p_mkt","p_fund","p_fund_t10","mispricing","div_yield"]
      .forEach(id=>el(id).textContent="â€“");
    return;
  }

  const f = d.fundamental;
  el("p_mkt").textContent = f.price_market.toFixed(2);
  el("p_fund").textContent = f.price_fundamental_now.toFixed(2);
  el("p_fund_t10").textContent = f.price_fundamental_t10.toFixed(2);
  el("mispricing").textContent = f.mispricing_pct.toFixed(1)+"%";
  el("div_yield").textContent = f.dividend_yield_pct.toFixed(2)+"%";
}

// ===============================
// GRÃFICO
// ===============================
async function loadChart(t){
  const p = await j(`${API}/dashboard/predictions?ticker=${t}`);
  const e = await j(`${API}/dashboard/evaluations?ticker=${t}`);

  const labels = p.data.map(x=>x.prediction.date_base);
  const pred = p.data.map(x=>x.prediction.price_pred);
  const real = e.data.map(x=>x.price_real ?? null);

  el("chart-info").textContent =
    real.every(v=>v===null)
      ? "PredicciÃ³n activa. Esperando cierre del horizonte."
      : "ComparaciÃ³n entre precio proyectado y precio real.";

  if(chart) chart.destroy();
  chart = new Chart(document.getElementById("chart"),{
    type:"line",
    data:{
      labels,
      datasets:[
        { label:"Precio proyectado (tÃ©cnico)",
          data:pred,
          borderColor:"#38bdf8",
          borderDash:[6,6],
          tension:.3 },
        { label:"Precio real",
          data:real,
          borderColor:"#22c55e",
          tension:.3 }
      ]
    },
    options:{ responsive:true }
  });
}

sel.addEventListener("change",e=>loadSignal(e.target.value));
loadTickers();
</script>
</body>
</html>
