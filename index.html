<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Quant Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* Badges sem√°nticos m√≠nimos */
    .badge { padding: 2px 8px; border-radius: 8px; font-weight: 600; }
    .strong { color: #16a34a; }
    .good   { color: #2563eb; }
    .weak   { color: #ca8a04; }
  </style>
</head>

<body>
<div class="container">
  <h1>üìà Quant Dashboard</h1>
  <p class="subtitle">
    Modelo t√©cnico + se√±ales | Horizonte: 10 sesiones
  </p>

  <!-- Status -->
  <div class="status-bar">
    <span id="status">Cargando‚Ä¶</span>
    <span class="last-update" id="last-update">‚Äì</span>
  </div>

  <!-- Selectores -->
  <div class="selectors-row">
    <div class="card">
      <label>üéØ Activo</label>
      <select id="ticker"></select>
    </div>
  </div>

  <!-- KPIs -->
  <div class="kpis-row">
    <div class="card">
      <h3>‚öôÔ∏è Se√±al T√©cnica</h3>
      <div class="kpis-grid">
        <div class="kpi"><span>Recomendaci√≥n</span><strong id="rec">‚Äì</strong></div>
        <div class="kpi"><span>Precio actual</span><strong id="pnow">‚Äì</strong></div>
        <div class="kpi"><span>Precio proyectado</span><strong id="ppred">‚Äì</strong></div>
        <div class="kpi"><span>Retorno esperado</span><strong id="ret">‚Äì</strong></div>
        <div class="kpi"><span>Confianza</span><strong id="conf">‚Äì</strong></div>
        <div class="kpi"><span>Calidad</span><strong id="quality">‚Äì</strong></div>
      </div>
    </div>
  </div>

  <!-- Chart -->
  <div class="card chart-card">
    <p id="chart-info" class="chart-info">‚Äì</p>
    <canvas id="chart"></canvas>
  </div>
</div>

<script>
const API = "https://spy-2w-price-prediction.onrender.com";
const sel = document.getElementById("ticker");
const el = id => document.getElementById(id);
let chart;

/* =======================
   Cache local de se√±ales
   ======================= */
let SIGNAL_CACHE = null;

/* =======================
   Helper fetch JSON
   ======================= */
async function j(url) {
  const r = await fetch(url);
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  return await r.json();
}

async function getSignals() {
  if (!SIGNAL_CACHE) {
    SIGNAL_CACHE = await j(`${API}/signals`);
  }
  return SIGNAL_CACHE;
}

/* =======================
   Load tickers (ordenados por confidence)
   ======================= */
async function loadTickers() {
  try {
    el("status").textContent = "Cargando se√±ales‚Ä¶";
    const d = await getSignals();

    sel.innerHTML = `<option value="">Selecciona un activo‚Ä¶</option>`;

    d.signals
      .sort((a, b) => (b.confidence ?? 0) - (a.confidence ?? 0))
      .forEach(s => {
        const o = document.createElement("option");
        o.value = s.ticker;
        o.textContent = `${s.ticker} | ${s.recommendation}`;
        sel.appendChild(o);
      });

    el("status").textContent = `‚úÖ ${d.signals.length} activos`;
    el("last-update").textContent =
      `Actualizado: ${new Date().toLocaleString("es-CL")}`;
  } catch (e) {
    el("status").textContent = "‚ùå Error cargando se√±ales";
    console.error(e);
  }
}

/* =======================
   Load single signal
   ======================= */
async function loadSignal(ticker) {
  if (!ticker) return;

  try {
    el("status").textContent = `Cargando ${ticker}‚Ä¶`;

    const d = await getSignals();
    const s = d.signals.find(x => x.ticker === ticker);
    if (!s) throw new Error("Signal not found");

    el("rec").textContent = s.recommendation || "‚Äì";
    el("pnow").textContent = s.price_now !== undefined
      ? `$${Number(s.price_now).toFixed(2)}`
      : "‚Äì";
    el("ppred").textContent = s.price_pred !== undefined
      ? `$${Number(s.price_pred).toFixed(2)}`
      : "‚Äì";
    el("ret").textContent = s.ret_ens_pct !== undefined
      ? `${Number(s.ret_ens_pct).toFixed(2)}%`
      : "‚Äì";
    el("conf").textContent = s.confidence !== null
      ? Number(s.confidence).toFixed(3)
      : "‚Äì";

    const q = el("quality");
    q.textContent = s.quality || "‚Äì";
    q.className = "badge " +
      (s.quality?.includes("STRONG") ? "strong" :
       s.quality?.includes("GOOD")   ? "good"   :
       "weak");

    await loadChart(ticker);
    el("status").textContent = `‚úÖ ${ticker} listo`;
  } catch (e) {
    el("status").textContent = `‚ùå Error ${ticker}`;
    console.error(e);
  }
}

/* =======================
   Chart (predictions + evals)
   ======================= */
async function loadChart(ticker) {
  try {
    const [pred, evals] = await Promise.all([
      j(`${API}/dashboard/predictions/summary?ticker=${ticker}`)
        .catch(() => ({ data: [] })),
      j(`${API}/dashboard/evaluations/summary?ticker=${ticker}`)
        .catch(() => ({ data: [] }))
    ]);

    const labels = pred.data.map(x =>
      new Date(x.date_base).toLocaleDateString("es-CL")
    );
    const projected = pred.data.map(x => x.price_pred);
    const real = evals.data.map(x => x.real_return_pct ?? null);

    el("chart-info").textContent =
      real.some(v => v !== null)
        ? "üìä Proyectado vs Real (evaluado)"
        : "üîÆ Predicci√≥n activa (observando)";

    if (chart) chart.destroy();

    chart = new Chart(el("chart"), {
      type: "line",
      data: {
        labels,
        datasets: [
          {
            label: "Proyectado",
            data: projected,
            borderColor: "#38bdf8",
            backgroundColor: "rgba(56,189,248,0.1)",
            borderWidth: 3,
            borderDash: [6,4],
            tension: 0.35,
            pointRadius: 6
          },
          {
            label: "Real",
            data: real,
            borderColor: "#22c55e",
            backgroundColor: "rgba(34,197,94,0.1)",
            borderWidth: 3,
            tension: 0.35,
            pointRadius: real.some(v => v !== null) ? 6 : 0
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: { beginAtZero: false },
          x: { ticks: { maxRotation: 45 } }
        }
      }
    });
  } catch (e) {
    el("chart-info").textContent = "‚ùå Error gr√°fico";
    console.error(e);
  }
}

/* =======================
   Events
   ======================= */
sel.addEventListener("change", e => loadSignal(e.target.value));

loadTickers();
</script>
</body>
</html>
