<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Quant Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      margin: 0;
      padding: 20px;
    }
    .container { max-width: 1100px; margin: auto; }
    .card {
      background: #020617;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid #1e293b;
    }
    select {
      background: #020617;
      color: #e5e7eb;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #334155;
    }
    .kpis {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 15px;
    }
    .kpi span { font-size: 13px; color: #94a3b8; }
    .kpi strong { font-size: 20px; display: block; margin-top: 4px; }
    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      font-weight: 600;
      display: inline-block;
    }
    .GOOD { background: #16a34a; }
    .WEAK { background: #ca8a04; }
    .NOISE { background: #dc2626; }
    .OBS { background: #334155; }
  </style>
</head>

<body>
<div class="container">

<h1>ðŸ“ˆ Quant Dashboard</h1>
<p>Estado operativo y validaciÃ³n temporal</p>

<div class="card">
  <label>Activo:</label>
  <select id="ticker"></select>
</div>

<div class="card kpis">
  <div class="kpi"><span>RecomendaciÃ³n</span><strong id="rec">â€“</strong></div>
  <div class="kpi"><span>Precio hoy</span><strong id="pnow">â€“</strong></div>
  <div class="kpi"><span>Precio objetivo</span><strong id="ppred">â€“</strong></div>
  <div class="kpi"><span>Retorno esperado</span><strong id="ret">â€“</strong></div>
  <div class="kpi"><span>Horizonte</span><strong id="horizon">â€“</strong></div>
  <div class="kpi"><span>Estado</span><strong id="state">â€“</strong></div>
</div>

<div class="card">
  <canvas id="chart" height="120"></canvas>
</div>

</div>

<script>
const API = "https://spy-2w-price-prediction.onrender.com";
const sel = document.getElementById("ticker");
const el = id => document.getElementById(id);
let chart;

async function j(url){ return (await fetch(url)).json(); }

async function loadTickers(){
  const d = await j(`${API}/signals`);
  sel.innerHTML = "";
  d.signals.forEach(s=>{
    const o=document.createElement("option");
    o.value=s.ticker; o.textContent=s.ticker;
    sel.appendChild(o);
  });
  loadSignal(sel.value);
}

async function loadSignal(t){
  const d = await j(`${API}/signals/${t}`);
  const s = d.signal;

  el("rec").textContent = s.recommendation;
  el("pnow").textContent = s.price_now.toFixed(2);
  el("ppred").textContent = s.price_pred.toFixed(2);
  el("ret").textContent = s.ret_ens_pct.toFixed(2)+"%";
  el("horizon").textContent = "10 dÃ­as";

  if (!s.confidence){
    el("state").innerHTML = `<span class="badge OBS">En observaciÃ³n</span>`;
  } else {
    el("state").innerHTML = `<span class="badge ${s.quality}">${s.quality}</span>`;
  }

  loadChart(t);
}

async function loadChart(t){
  const p = await j(`${API}/dashboard/predictions?ticker=${t}`);
  const e = await j(`${API}/dashboard/evaluations?ticker=${t}`);

  const labels = p.data.map(x=>x.prediction.date_base);
  const pred = p.data.map(x=>x.prediction.price_pred);
  const real = e.data.map(x=>x.price_real ?? null);

  if(chart) chart.destroy();
  chart = new Chart(document.getElementById("chart"),{
    type:"line",
    data:{
      labels,
      datasets:[
        {label:"PredicciÃ³n", data:pred, borderColor:"#38bdf8", tension:.3},
        {label:"Real", data:real, borderColor:"#22c55e", tension:.3}
      ]
    },
    options:{responsive:true}
  });
}

sel.addEventListener("change",e=>loadSignal(e.target.value));
loadTickers();
</script>
</body>
</html>
